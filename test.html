<!DOCTYPE html>
<html lang="es">
<head>
    <!-- ... (estilos iguales que antes) ... -->
    <style>
        /* Todos los estilos anteriores se mantienen igual */
    </style>
</head>
<body>
    <!-- ... (HTML igual que antes) ... -->

    <script>
        class AudioPlayer {
            constructor() {
                this.audio = document.createElement('video');
                this.audio.id = 'videoElement';
                this.audio.style.display = 'none';
                document.body.appendChild(this.audio);
                this.playlist = [];
                this.currentTrack = 0;
                this.isPlaying = false;
                this.currentMedia = null;
                this.youtubeInterval = null;

                // Elementos del DOM (igual que antes)
                
                // Verificar carga de la API de YouTube
                if (typeof YT === 'undefined' || typeof YT.Player === 'undefined') {
                    console.error('YouTube API no está cargada');
                    this.showError('Error: YouTube Player API no está disponible');
                }

                this.initialize();
            }

            initialize() {
                this.setupEventListeners();
            }

            // ... (setupEventListeners y otros métodos iguales hasta handleUrl) ...

            async handleUrl() {
                try {
                    const url = document.getElementById('urlInput').value;
                    if (!url) return;

                    let type, videoId = null;
                    const youtubeMatch = url.match(/(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/|youtube\.com\/v\/)([\w-]{11})/);
                    if (youtubeMatch) {
                        type = 'youtube';
                        videoId = youtubeMatch[1];
                    } else {
                        // Validación para otros tipos (igual que antes)
                    }

                    const title = type === 'youtube' ? `YouTube Video (${videoId})` : url.split('/').pop();
                    this.addToPlaylist(title, url, type, videoId);

                    if (this.playlist.length > 0) this.loadTrack();
                    document.getElementById('urlInput').value = '';
                } catch (error) {
                    this.showError(error.message);
                }
            }

            async loadTrack() {
                try {
                    if (this.playlist.length === 0) return;
                    const track = this.playlist[this.currentTrack];
                    this.pause();

                    if (track.type === 'youtube') {
                        if (!track.player) {
                            const playerDiv = document.createElement('div');
                            playerDiv.id = `youtube-player-${Date.now()}`;
                            playerDiv.style.display = 'none';
                            document.body.appendChild(playerDiv);

                            track.player = new YT.Player(playerDiv.id, {
                                height: '0',
                                width: '0',
                                videoId: track.videoId,
                                playerVars: {
                                    autoplay: 0,
                                    controls: 0,
                                    disablekb: 1,
                                    modestbranding: 1
                                },
                                events: {
                                    'onReady': (event) => {
                                        this.currentMedia = event.target;
                                        this.playBtn.textContent = '▶';
                                    },
                                    'onStateChange': (event) => {
                                        if (event.data === YT.PlayerState.PLAYING) {
                                            this.isPlaying = true;
                                            this.youtubeInterval = setInterval(() => {
                                                this.updateProgress();
                                            }, 1000);
                                        } else if (event.data === YT.PlayerState.PAUSED) {
                                            this.isPlaying = false;
                                        } else if (event.data === YT.PlayerState.ENDED) {
                                            this.playNext();
                                        }
                                    },
                                    'onError': (event) => {
                                        this.handleYoutubeError(event.data);
                                    }
                                }
                            });
                        } else {
                            this.currentMedia = track.player;
                        }
                    } else {
                        // Código para otros tipos igual que antes
                    }
                } catch (error) {
                    this.showError('Error al cargar: ' + error.message);
                    this.playNext();
                }
            }

            handleYoutubeError(errorCode) {
                let errorMsg = 'Error de YouTube: ';
                switch (errorCode) {
                    case 2: errorMsg += 'ID de video inválido'; break;
                    case 5: errorMsg += 'Error de HTML5'; break;
                    case 100: errorMsg += 'Video no encontrado'; break;
                    case 101: 
                    case 150: errorMsg += 'Reproducción restringida'; break;
                    default: errorMsg += `Código ${errorCode}`;
                }
                this.showError(errorMsg);
                this.playNext();
            }

            play() {
                if (!this.isPlaying && this.currentMedia) {
                    if (this.currentMedia instanceof HTMLMediaElement) {
                        this.currentMedia.play();
                    } else if (typeof this.currentMedia.playVideo === 'function') {
                        this.currentMedia.playVideo();
                        this.isPlaying = true;
                        this.playBtn.textContent = '⏸';
                    }
                }
            }

            pause() {
                if (this.isPlaying && this.currentMedia) {
                    if (this.currentMedia instanceof HTMLMediaElement) {
                        this.currentMedia.pause();
                    } else if (typeof this.currentMedia.pauseVideo === 'function') {
                        this.currentMedia.pauseVideo();
                        this.isPlaying = false;
                        this.playBtn.textContent = '▶';
                    }
                    if (this.youtubeInterval) {
                        clearInterval(this.youtubeInterval);
                        this.youtubeInterval = null;
                    }
                }
            }

            updateProgress() {
                if (this.currentMedia instanceof HTMLMediaElement) {
                    // Código original
                } else if (this.currentMedia && typeof this.currentMedia.getCurrentTime === 'function') {
                    const duration = this.currentMedia.getDuration();
                    const currentTime = this.currentMedia.getCurrentTime();
                    if (duration > 0) {
                        const progress = (currentTime / duration) * 100;
                        this.progressBar.style.width = `${progress}%`;
                    }
                }
            }

            // ... (otros métodos se mantienen igual) ...
        }

        // Cargar YouTube API correctamente
        let tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        let firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        // Inicialización después de cargar la API
        let player;
        function onYouTubeIframeAPIReady() {
            player = new AudioPlayer();
            window.player = player;
        }
    </script>
    <!-- ... (resto del código igual) ... -->
</body>
</html>
