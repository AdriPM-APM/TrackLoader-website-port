<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#4CAF50">
    <title>Modern Audio Player</title>
    <style>
        :root {
            --primary-color: #4CAF50;
            --bg-color: #ffffff;
            --text-color: #333333;
            --secondary-bg: #f0f0f0;
            --border-color: #e0e0e0;
            --hover-color: #45a049;
            --remove-color: #ff4444;
            --remove-hover: #cc0000;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: #1a1a1a;
                --text-color: #ffffff;
                --secondary-bg: #2d2d2d;
                --border-color: #404040;
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--secondary-bg);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: var(--text-color);
        }

        .player-container {
            background: var(--bg-color);
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            width: 90%;
            max-width: 400px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .player-title {
            text-align: center;
            margin-bottom: 20px;
            color: var(--text-color);
            font-weight: 600;
        }

        .now-playing {
            text-align: center;
            margin-bottom: 15px;
            font-size: 14px;
            color: var(--text-color);
            opacity: 0.8;
        }

        .progress-container {
            width: 100%;
            height: 4px;
            background: var(--border-color);
            border-radius: 2px;
            margin-bottom: 15px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: var(--primary-color);
            border-radius: 2px;
            transform: translateX(-100%);
            will-change: transform;
        }

        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 15px;
        }

        .control-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 24px;
            color: var(--text-color);
            padding: 8px;
            border-radius: 50%;
            transition: background-color 0.2s;
            -webkit-tap-highlight-color: transparent;
        }

        .control-btn:active {
            background-color: var(--secondary-bg);
        }

        .volume-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .volume-slider {
            width: 100px;
            -webkit-appearance: none;
            appearance: none;
            height: 4px;
            background: var(--border-color);
            border-radius: 2px;
            outline: none;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            background: var(--primary-color);
            border-radius: 50%;
            cursor: pointer;
        }

        .file-input-container {
            margin-bottom: 20px;
            text-align: center;
        }

        .file-input-btn {
            background: var(--primary-color);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.2s;
            -webkit-tap-highlight-color: transparent;
        }

        .file-input-btn:active {
            background: var(--hover-color);
        }

        #fileInput {
            display: none;
        }

        .playlist {
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--primary-color) var(--border-color);
        }

        .playlist::-webkit-scrollbar {
            width: 6px;
        }

        .playlist::-webkit-scrollbar-track {
            background: var(--border-color);
            border-radius: 3px;
        }

        .playlist::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 3px;
        }

        .playlist-item {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s;
        }

        .playlist-item:active {
            background: var(--secondary-bg);
        }

        .playlist-item.active {
            background: var(--secondary-bg);
            color: var(--primary-color);
        }

        .remove-track {
            color: var(--remove-color);
            cursor: pointer;
            padding: 5px;
            font-size: 18px;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .remove-track:active {
            opacity: 1;
        }

        @media (hover: hover) {
            .control-btn:hover {
                background-color: var(--secondary-bg);
            }

            .file-input-btn:hover {
                background: var(--hover-color);
            }

            .playlist-item:hover {
                background: var(--secondary-bg);
            }

            .remove-track:hover {
                opacity: 1;
            }
        }

        .error-message {
            color: var(--remove-color);
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            display: none;
        }

        .loading {
            text-align: center;
            padding: 10px;
            display: none;
        }

        .loading::after {
            content: '...';
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { content: '.'; }
            33% { content: '..'; }
            66% { content: '...'; }
        }
    </style>
</head>
<body>
    <div class="player-container">
        <h2 class="player-title">Audio Player</h2>
        
        <div class="error-message" id="errorMessage"></div>
        <div class="loading" id="loadingMessage">Loading</div>
        
        <div class="file-input-container">
            <input type="file" id="fileInput" accept="audio/*" multiple>
            <button class="file-input-btn" onclick="document.getElementById('fileInput').click()">
                Select Audio Files
            </button>
        </div>

        <div class="now-playing">No track selected</div>
        
        <div class="progress-container">
            <div class="progress-bar"></div>
        </div>

        <div class="controls">
            <button class="control-btn" id="prevBtn">‚èÆ</button>
            <button class="control-btn" id="playBtn">‚ñ∂</button>
            <button class="control-btn" id="nextBtn">‚è≠</button>
        </div>

        <div class="volume-container">
            <span>üîà</span>
            <input type="range" class="volume-slider" min="0" max="1" step="0.1" value="1">
        </div>

        <div class="playlist">
            <!-- Playlist items will be added here -->
        </div>
    </div>

    <script>
        class AudioPlayer {
            constructor() {
                this.audio = new Audio();
                this.playlist = [];
                this.currentTrack = 0;
                this.isPlaying = false;
                this.progressUpdateInterval = null;
                this.lastProgressUpdate = 0;
                this.progressUpdateThrottle = 100; // ms
                this.errorMessage = document.getElementById('errorMessage');
                this.loadingMessage = document.getElementById('loadingMessage');

                // DOM Elements
                this.playBtn = document.getElementById('playBtn');
                this.prevBtn = document.getElementById('prevBtn');
                this.nextBtn = document.getElementById('nextBtn');
                this.volumeSlider = document.querySelector('.volume-slider');
                this.progressBar = document.querySelector('.progress-bar');
                this.progressContainer = document.querySelector('.progress-container');
                this.nowPlaying = document.querySelector('.now-playing');
                this.playlistContainer = document.querySelector('.playlist');
                this.fileInput = document.getElementById('fileInput');

                // Check for Android
                this.isAndroid = /Android/i.test(navigator.userAgent);

                // Initialize audio context
                this.initAudioContext();

                // Event Listeners with passive options for better performance
                this.setupEventListeners();
            }

            async initAudioContext() {
                try {
                    // Create audio context
                    window.AudioContext = window.AudioContext || window.webkitAudioContext;
                    this.audioContext = new AudioContext();
                    
                    // Resume audio context on user interaction
                    document.addEventListener('click', () => {
                        if (this.audioContext.state === 'suspended') {
                            this.audioContext.resume();
                        }
                    }, { once: true });
                } catch (error) {
                    this.showError('Audio initialization failed: ' + error.message);
                }
            }

            setupEventListeners() {
                this.playBtn.addEventListener('click', () => this.togglePlay(), { passive: true });
                this.prevBtn.addEventListener('click', () => this.playPrevious(), { passive: true });
                this.nextBtn.addEventListener('click', () => this.playNext(), { passive: true });
                this.volumeSlider.addEventListener('input', (e) => this.setVolume(e.target.value), { passive: true });
                this.progressContainer.addEventListener('click', (e) => this.seek(e), { passive: true });
                this.fileInput.addEventListener('change', (e) => this.handleFileSelect(e), { passive: true });

                // Optimized timeupdate event
                this.audio.addEventListener('timeupdate', () => {
                    const now = performance.now();
                    if (now - this.lastProgressUpdate >= this.progressUpdateThrottle) {
                        this.updateProgress();
                        this.lastProgressUpdate = now;
                    }
                }, { passive: true });

                this.audio.addEventListener('ended', () => this.playNext(), { passive: true });
                
                // Error handling
                this.audio.addEventListener('error', (e) => {
                    this.showError('Error playing audio: ' + (e.target.error?.message || 'Unknown error'));
                });

                // Handle visibility change
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden && this.isPlaying) {
                        this.pause();
                    }
                });
            }

            showError(message) {
                this.errorMessage.textContent = message;
                this.errorMessage.style.display = 'block';
                setTimeout(() => {
                    this.errorMessage.style.display = 'none';
                }, 5000);
            }

            showLoading(show) {
                this.loadingMessage.style.display = show ? 'block' : 'none';
            }

            async handleFileSelect(event) {
                try {
                    this.showLoading(true);
                    const files = event.target.files;
                    
                    for (let file of files) {
                        if (file.type.startsWith('audio/')) {
                            try {
                                // Create object URL
                                const url = URL.createObjectURL(file);
                                
                                // Test if audio can be played
                                const testAudio = new Audio();
                                testAudio.src = url;
                                
                                await new Promise((resolve, reject) => {
                                    testAudio.addEventListener('canplaythrough', resolve, { once: true });
                                    testAudio.addEventListener('error', reject, { once: true });
                                    testAudio.load();
                                });
                                
                                this.addTrack(file.name, url);
                            } catch (error) {
                                this.showError(`Error loading ${file.name}: ${error.message}`);
                            }
                        }
                    }
                    
                    if (this.playlist.length > 0 && !this.isPlaying) {
                        await this.loadTrack();
                    }
                } catch (error) {
                    this.showError('Error processing files: ' + error.message);
                } finally {
                    this.showLoading(false);
                }
            }

            async loadTrack() {
                if (this.playlist.length === 0) return;
                
                try {
                    this.showLoading(true);
                    const track = this.playlist[this.currentTrack];
                    
                    // Reset audio
                    this.audio.pause();
                    this.audio.src = '';
                    
                    // Set new source
                    this.audio.src = track.src;
                    this.nowPlaying.textContent = track.title;
                    
                    // Load the audio
                    await new Promise((resolve, reject) => {
                        this.audio.addEventListener('canplaythrough', resolve, { once: true });
                        this.audio.addEventListener('error', reject, { once: true });
                        this.audio.load();
                    });
                    
                    this.updatePlaylistUI();
                } catch (error) {
                    this.showError('Error loading track: ' + error.message);
                } finally {
                    this.showLoading(false);
                }
            }

            async play() {
                try {
                    if (this.audioContext?.state === 'suspended') {
                        await this.audioContext.resume();
                    }
                    await this.audio.play();
                    this.isPlaying = true;
                    this.playBtn.textContent = '‚è∏';
                } catch (error) {
                    this.showError('Error playing audio: ' + error.message);
                    this.isPlaying = false;
                    this.playBtn.textContent = '‚ñ∂';
                }
            }

            togglePlay() {
                if (this.playlist.length === 0) return;
                
                if (this.isPlaying) {
                    this.pause();
                } else {
                    this.play();
                }
            }

            pause() {
                this.audio.pause();
                this.isPlaying = false;
                this.playBtn.textContent = '‚ñ∂';
            }

            playNext() {
                if (this.playlist.length === 0) return;
                
                this.currentTrack = (this.currentTrack + 1) % this.playlist.length;
                this.loadTrack();
                this.play();
            }

            playPrevious() {
                if (this.playlist.length === 0) return;
                
                this.currentTrack = (this.currentTrack - 1 + this.playlist.length) % this.playlist.length;
                this.loadTrack();
                this.play();
            }

            setVolume(value) {
                this.audio.volume = value;
            }

            seek(e) {
                if (this.playlist.length === 0) return;
                
                const percent = e.offsetX / this.progressContainer.offsetWidth;
                this.audio.currentTime = percent * this.audio.duration;
            }

            updateProgress() {
                if (this.playlist.length === 0) return;
                
                const percent = (this.audio.currentTime / this.audio.duration) * 100;
                this.progressBar.style.transform = `translateX(${percent - 100}%)`;
            }

            updatePlaylistUI() {
                const items = this.playlistContainer.children;
                for (let i = 0; i < items.length; i++) {
                    items[i].classList.toggle('active', i === this.currentTrack);
                }
            }

            addTrack(title, src) {
                this.playlist.push({ title, src });
                const item = document.createElement('div');
                item.className = 'playlist-item';
                
                const titleSpan = document.createElement('span');
                titleSpan.textContent = title;
                
                const removeBtn = document.createElement('span');
                removeBtn.className = 'remove-track';
                removeBtn.textContent = '√ó';
                removeBtn.onclick = (e) => {
                    e.stopPropagation();
                    this.removeTrack(this.playlist.findIndex(track => track.title === title));
                };

                item.appendChild(titleSpan);
                item.appendChild(removeBtn);
                
                item.addEventListener('click', () => {
                    this.currentTrack = this.playlist.findIndex(track => track.title === title);
                    this.loadTrack();
                    this.play();
                }, { passive: true });
                
                this.playlistContainer.appendChild(item);
            }

            removeTrack(index) {
                if (index === this.currentTrack) {
                    this.pause();
                    this.audio.src = '';
                    this.nowPlaying.textContent = 'No track selected';
                }
                
                this.playlist.splice(index, 1);
                this.playlistContainer.removeChild(this.playlistContainer.children[index]);
                
                if (this.playlist.length === 0) {
                    this.currentTrack = 0;
                } else if (index < this.currentTrack) {
                    this.currentTrack--;
                } else if (this.currentTrack >= this.playlist.length) {
                    this.currentTrack = this.playlist.length - 1;
                }
                
                this.updatePlaylistUI();
            }
        }

        // Initialize the player
        const player = new AudioPlayer();

        // Handle Android back button
        if (window.Android) {
            document.addEventListener('backbutton', (e) => {
                if (player.isPlaying) {
                    e.preventDefault();
                    player.pause();
                }
            });
        }
    </script>
</body>
</html>
